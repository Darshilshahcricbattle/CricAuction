name: Daily CricAuction Scraper

on:
  schedule:
    # Runs daily at 9:00 AM IST (3:30 AM UTC)
    - cron: '30 3 * * *'
  workflow_dispatch: # Allows manual trigger

# ðŸ‘‡ NEW: allow github-actions[bot] to push commits
permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          clean: true
          persist-credentials: true   # ðŸ‘ˆ explicit, so push uses GITHUB_TOKEN
      
      - name: Verify code version
        run: |
          echo "=== Code Version Check ==="
          git log -1 --oneline
          echo "=== Credential Function Check ==="
          grep -A 5 "def try_load_creds" scrape_auctions_updated.py || echo "Function not found!"
          echo "=== No JSON Loading Check ==="
          if grep -q "json.load" scrape_auctions_updated.py; then
            echo "ERROR: Old code detected with json.load!"
            exit 1
          else
            echo "âœ“ Correct code - no JSON file loading"
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests
      
      - name: Install Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Run scraper
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CB_EMAIL: ${{ secrets.CB_EMAIL }}
          CB_PASSWORD: ${{ secrets.CB_PASSWORD }}
        run: |
          python scrape_auctions_updated.py
      
      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # ðŸ‘ˆ not strictly required but explicit
        run: |
          git config --global user.name 'Darshilshahcricbattle'
          git config --global user.email 'darshil@cricbattle.com'

          git add cricauction_upcoming.csv

          # Only commit if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update auction data - $(date +'%Y-%m-%d')"
            # use the token-backed remote set by actions/checkout
            git push origin HEAD:${{ github.ref_name }}
          fi
